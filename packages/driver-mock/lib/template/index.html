<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>mock-server</title>
    <!-- import CSS -->
    <link rel="stylesheet" href="mockServer/assets/element-ui@2.13.0/theme-chalk/index.css">
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        .text-overflow-style {
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .text-no-wrap {
            white-space: nowrap;
        }
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
        }
        #app {
            height: 100%;
        }
        .header {
            display: flex;
            justify-content: space-between;
            background: rgb(84, 92, 100);
            align-items: center;
        }
        .logo-wrap {
            color: #fff;
            display: flex;
            align-items: center;
            margin: 0 30px 0 20px;
            text-decoration: none;
        }
        .logo {
            margin-right: 10px;
        }
        .el-menu-main {
            flex: 1;
        }
        .content {
            display: flex;
            height: calc(100% - 60px);
            background: #f7f7f7;
        }
        .left {
            flex-basis: 320px;
            background: #fff;
            border-right: 1px solid #ccc;
            overflow-y: auto;
        }
        .left-header {
            padding: 15px;
            border-bottom: 1px solid #f9f6f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-wrap {
            margin-right: 10px;
        }
        .icon-plus-api {
            cursor: pointer;
            color: #666666;
        }
        .icon-plus-api:hover {
            color: #50a6ff
        }
        .el-menu-vertical-wrap {
            border-right: none;
        }
        /* .el-menu-item-api {
            overflow: hidden;
            text-overflow: ellipsis;
        } */
        .el-munu-item-wrap {
            display: flex;
            position: relative;
            justify-content: space-between;
        }
        .el-menu-btns {
            display: none;
            background: #afa8a8;
            position: absolute;
            right: -20px;
            border-top-left-radius: 10px;
            height: 27px;
            align-items: center;
            bottom: 0;
            color:#fff;
        }
        .menu-opera-icon {
            font-size: 12px!important;
            color: #fff!important;
        }
        .el-munu-item-wrap:hover .el-menu-btns {
            display: flex;
        }

        .right {
            flex: 1;
            padding: 15px;
        }
        .right-header {
            display: flex;
            align-items: center;
        }
        .right-title {
            margin-right: 15px;
        }
        /* .scenes-wrap {
            display: flex;
        } */
        .scene-card-wrap {
            margin-bottom: 20px;
        }
        .scene-card-add-wrap {
            cursor: pointer;
        }


        .scene-card {
            width: 240px;
        }
        .scene-active-card {
            box-shadow: 0 2px 12px 0 rgba(5, 116, 230, 0.6) !important;
        }
        .scene-desc {
            font-size: 13px;
            color: #999;
        }
        
        .scene-bottom {
            margin-top: 13px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        .scene-extra-bottom {
            justify-content: space-between;
        }
        .scene-title {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .scene-button .scene-icon, .btn-opera {
            color: #4ba4ff;
            margin-left: 10px;
            cursor: pointer;
        }
        .scene-button .el-icon-turn-off {
            color:#ccc;
        }
        /* .scene-card:hover .el-icon-turn-off {
            color: #4ba4ff;
        } */
        .scene-image {
            width: 100%;
            height: 100px;
            background: #949292;
            align-items: center;
            justify-content: center;
            display: flex;
            color: #ccc;
        }
        .scene-text {
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 10px;
        }
        .scene-image-add {
            background: #f7f7ff;
        }
        .scene-text-add {
            font-size: 50px;
        }

        .form-item {
            width: 300px;
        }
        .scene-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

    </style>
    <!-- import Vue before Element -->
    <script src="mockServer/assets/vue@2.6.11/vue.js"></script>
    <!-- import JavaScript -->
    <script src="mockServer/assets/element-ui@2.13.0/index.js"></script>
</head>
<body>
    <div id="app">
        <div class="header">
            <a href="/" class="logo-wrap">
                <img src="https://img.alicdn.com/tfs/TB18Xm_q5_1gK0jSZFqXXcpaXXa-34-34.svg" class="logo" />
                MOCK平台
            </a>
            <el-menu
                :default-active="activeIndex"
                class="el-menu-main"
                mode="horizontal"
                @select="handleSelect"
                background-color="#545c64"
                text-color="#fff"
                active-text-color="#ffd04b">
                <el-menu-item index="1">接口列表</el-menu-item>
                <el-menu-item index="2">场景中心</el-menu-item>
              </el-menu>
        </div>
        <div class="content" v-if="activeIndex === '1'">
            <div class="left">
                <div class="left-header">
                    <div class="search-wrap">
                        <el-input placeholder="输入接口搜索" v-model="curSearchApi" class="input-with-select">
                            <el-button slot="append" icon="el-icon-search"></el-button>
                        </el-input>
                    </div>
                    <el-button type="primary" @click="addorEditApi">新增</el-button>
                </div>
                <el-menu :default-active="activeApi" @select="handleSelectApi" class="el-menu-vertical-wrap" :collapse="isCollapse">
                    <el-menu-item v-show="!curSearchApi || item.api.includes(curSearchApi)" :index="item.api" v-for="(item, index) of API_LIST" :title="item.api" :key="item.api">
                        <div class="el-munu-item-wrap">
                            <span class="text-overflow-style">
                                {{item.api}}
                            </span>
                            <span class="el-menu-btns">
                                <i class="el-icon-edit menu-opera-icon" @click="addorEditApi(index, item.api)" title="编辑"></i>
                                <i class="el-icon-delete menu-opera-icon" title="删除" @click="deleteApi(index)"></i>
                            </span>
                        </div>
                    </el-menu-item>
                </el-menu>
            </div>
            <div class="right">
                <template v-if="activeApi">
                    <div class="right-header">
                        <h3 class="right-title">{{activeApi}}</h3>
                        <el-tooltip effect="dark" content="同一接口同一时间只能开启一个场景哦" placement="bottom">
                            <i class="el-icon-info"></i>
                        </el-tooltip>
                    </div>
                    <el-row class="scenes-wrap">
                        <el-col :span="4" class="scene-card-wrap scene-card-add-wrap">
                            <el-card  class="scene-card" :body-style="{ padding: '0px' }">
                                <span class="scene-image scene-image-add" @click="addApiScene">
                                    <span class="scene-text scene-text-add">+</span>
                                </span>
                            <div style="padding: 14px;">
                                <div class="scene-bottom">
                                    <div class="scene-desc">
                                        新增接口场景
                                    </div>
                                </div>
                            </div>
                            </el-card>
                        </el-col>
                        <template v-if="activeAPISetting && activeAPISetting.scenes && activeAPISetting.scenes.length" >
                            <el-col :span="4" class="scene-card-wrap" v-for="(scene, index) of activeAPISetting.scenes" :key="scene">
                                <el-card  :class="activeAPISetting.activeScene === scene ? 'scene-card scene-active-card' : 'scene-card'" :body-style="{ padding: '0px' }" >
                                    <span class="scene-image">
                                        <span class="scene-text">{{scene}}</span>
                                    </span>
                                <div style="padding: 14px;">
                                    <div class="scene-bottom">
                                        <div class="scene-button">
                                            <el-tooltip effect="dark" content="当前场景开启，点击关闭" placement="top" v-if="activeAPISetting.activeScene === scene">
                                                <i class="el-icon-open scene-icon" @click="changeActiveScene(scene, false)"></i>
                                            </el-tooltip>
                                            <el-tooltip effect="dark" content="当前场景关闭，点击开启" placement="top" v-else>
                                                <i class="el-icon-turn-off scene-icon" @click="changeActiveScene(scene, true)"></i>
                                            </el-tooltip>
                                            <i class="el-icon-edit scene-icon" @click="addApiScene(index, scene)"></i>
                                            <i class="el-icon-delete scene-icon" @click="deleteApiScene(index)"></i>
                                        </div>
                                    </div>
                                </div>
                                </el-card>
                            </el-col>
                        </template>
                    </el-row>
                </template>
            </div>
        </div>

        <div class="content" v-if="activeIndex === '2'">
            <div class="left">
                <div class="left-header">
                    <div class="search-wrap">
                        <el-input placeholder="输入页面路由搜索" v-model="curSearchRouter" class="input-with-select">
                            <el-button slot="append" icon="el-icon-search"></el-button>
                        </el-input>
                    </div>
                    <el-button type="primary" @click="addRouter">新增</el-button>
                </div>
                    <el-menu :default-active="activeRouter" @select="handleSelectRouter" class="el-menu-vertical-wrap" :collapse="isCollapse">
                        <el-menu-item v-show="!curSearchRouter || item.url.includes(curSearchRouter)" :index="item.url" v-for="(item, index) of ROUTER_SCENE_GROUP_LIST" :title="item.url" :key="item.url">
                            <div class="el-munu-item-wrap">
                                <span class="text-overflow-style">
                                    {{item.url}}
                                </span>
                                <span class="el-menu-btns">
                                    <i class="el-icon-edit menu-opera-icon" @click="addRouter(index, item.url)" title="编辑"></i>
                                    <i class="el-icon-delete menu-opera-icon" @click="deleteRouter(index)" title="删除"></i>
                                </span>
                            </div>
                        </el-menu-item>
                    </el-menu>

            </div>
            <div class="right">
                <template v-if="activeRouter && hideSceneGroup">
                    <div class="right-header">
                        <h3 class="right-title">路由：{{activeRouter}}</h3>
                        <el-tooltip effect="dark" content="XXXX" placement="bottom">
                            <i class="el-icon-info"></i>
                        </el-tooltip>
                    </div>

                    <el-row class="scenes-wrap">
                        <el-col :span="4" class="scene-card-wrap scene-card-add-wrap" >
                            <el-card  class="scene-card" :body-style="{ padding: '0px' }" >
                                <span class="scene-image scene-image-add" @click="addRouterScene">
                                    <span class="scene-text scene-text-add">+</span>
                                </span>
                            <div style="padding: 27px;">
                                <div class="scene-bottom">
                                    <div class="scene-desc">
                                        新增页面场景组
                                    </div>
                                </div>
                            </div>
                            </el-card>
                        </el-col>
                        <template v-if="activeRouterSetting && activeRouterSetting.scenes" >
                            <el-col :span="4" class="scene-card-wrap" v-for="(sceneItem, index) of (activeRouterSetting.scenes || [])" :key="sceneItem.name">
                                <el-card  :class="sceneItem.name === activeRouterSetting.activeScene ? 'scene-card scene-active-card' : 'scene-card'" :body-style="{ padding: '0px' }" >
                                    <span class="scene-image" @click="goSceneGroupDetail(index, sceneItem)">
                                        <span class="scene-text">{{sceneItem.name}}</span>
                                    </span>
                                    <div style="padding: 14px;">
                                        <div class="scene-title">场景组：{{sceneItem.name}}</div>
                                        <div class="scene-bottom scene-extra-bottom">
                                            <div class="scene-desc">
                                                接口：{{(sceneItem.group || []).length}} 个
                                            </div>
                                            <div class="scene-button">
                                                <el-tooltip effect="dark" content="当前场景开启，点击关闭" placement="top" v-if="sceneItem.name === activeRouterSetting.activeScene">
                                                    <i class="el-icon-open scene-icon" @click="changeActiveSceneGroup(sceneItem.name, false)"></i>
                                                </el-tooltip>
                                                <el-tooltip effect="dark" content="当前场景关闭，点击开启" placement="top" v-else>
                                                    <i class="el-icon-turn-off scene-icon" @click="changeActiveSceneGroup(sceneItem.name, true)"></i>
                                                </el-tooltip>
                                                <i class="el-icon-edit scene-icon" @click="addRouterScene(index, sceneItem.name)"></i>
                                                <i class="el-icon-delete scene-icon" @click="deleteRouterScene(index)"></i>
                                                <el-tooltip effect="dark" content="查看关联API" placement="top">
                                                    <i class="el-icon-d-arrow-right scene-icon" @click="goSceneGroupDetail(index, sceneItem)"></i>
                                                </el-tooltip>
                                            </div>
                                        </div>
                                    </div>
                                </el-card>
                            </el-col>
                        </template>
                    </el-row>
                </template>
                <template v-if="!hideSceneGroup">
                    <div class="scene-header">
                        <h3>
                            场景组： {{activeSceneGroup.name}}
                            <el-button type="text" @click="goback">返回</el-button>
                        </h3>
                        <el-button plain type="primary" @click="addApiMap">新增API</el-button>
                    </div>
                    <el-table :data="activeSceneGroup.group" border style="width: 100%">
                        <el-table-column prop="api" label="接口名">
                            <template slot-scope="scope">
                                <template>
                                    <el-tooltip effect="dark" :content="scope.row.api" placement="top">
                                        <div class="text-overflow-style text-nowrap">{{scope.row.api}}</div>
                                    </el-tooltip>
                                </template>
                            </template>
                        </el-table-column>
                        <el-table-column prop="scene" label="场景">
                            <template slot-scope="scope">
                                <div class="select-scene-wrap">
                                    <template>
                                        {{scope.row.scene || 'default'}}
                                    </template>
                                </div>
                            </template>
                        </el-table-column>
                        <el-table-column label="操作" width="100px">
                            <template slot-scope="scope">
                                <i class="el-icon-edit btn-opera" @click="addApiMap(scope.$index, scope.row)"></i>
                                <i class="el-icon-delete btn-opera" @click="deleteApiMap(scope.$index)" title="删除API"></i>
                            </template>
                        </el-table-column>
                    </el-table>
                </template>
            </div>
        </div>

        <!-- 新增api -->
        <el-dialog :title="apiEditIndex > -1 ? '编辑接口' : '新增接口'" :visible.sync="addApiVisible" width="500px">
            <el-form :model="addApiForm">
                <template>
                    <el-form-item required label="接口路径" :label-width="formLabelWidth">
                        <el-select class="form-item" v-model="addApiForm.api" no-match-text="请输入接口路径" allow-create filterable clearable placeholder="请输入接口路径">
                            <el-option
                                v-for="item in AUTO_API_LIST"
                                :key="item.api"
                                :label="item.api"
                                :value="item.api">
                            </el-option>
                        </el-select>
                    </el-form-item>
                </template>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="addApiVisible = false">取 消</el-button>
                <el-button type="primary" @click="saveApi">确 定</el-button>
            </div>
        </el-dialog>
        <!-- 新增接口场景 -->
        <el-dialog :title="apiSceneEditIndex > -1 ? '编辑接口场景' : '新增接口场景'" :visible.sync="addApiSceneVisible" width="50%">
            <el-form :model="addApiSceneForm">
                <template>
                    <el-form-item required label="场景名称" :label-width="formLabelWidth">
                        <el-select class="form-item" v-model="addApiSceneForm.scene" no-match-text="请输入场景名称" allow-create filterable clearable placeholder="请输入场景名称">
                            <el-option
                                v-for="item in (AUTO_API_SCENE[this.activeApi] || [])"
                                :key="item"
                                :label="item"
                                :value="item">
                            </el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item required label="场景数据" :label-width="formLabelWidth">
                        <textarea v-model="addApiSceneForm.data" id="jsonEditor" style="width: 100%; height: 400px;">
                        </textarea>
                    </el-form-item>
                </template>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="addApiSceneVisible = false">取 消</el-button>
                <el-button type="primary" @click="saveApiScene">确 定</el-button>
            </div>
        </el-dialog>
        <!-- 新增页面路由 -->
        <el-dialog :title="routerEditIndex > -1 ? '编辑页面路由' : '新增页面路由'" :visible.sync="addRouterVisible" width="500px">
            <el-form :model="addRouterForm">
                <template>
                    <el-form-item required label="页面路由" :label-width="formLabelWidth">
                        <el-input v-model="addRouterForm.url" class="form-item"></el-input>
                    </el-form-item>
                </template>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="addRouterVisible = false">取 消</el-button>
                <el-button type="primary" @click="saveRouter">确 定</el-button>
            </div>
        </el-dialog>
        <!-- 新增路由场景组 -->
        <el-dialog :title="routerSceneEditIndex > -1 ? '编辑路由场景组' : '新增路由场景组'" :visible.sync="addRouterSceneVisible" width="500px">
            <el-form :model="addRouterSceneForm">
                <template>
                    <el-form-item required label="场景名称" :label-width="formLabelWidth">
                        <el-input v-model="addRouterSceneForm.name" class="form-item"></el-input>
                    </el-form-item>
                </template>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="addRouterSceneVisible = false">取 消</el-button>
                <el-button type="primary" @click="saveRouterScene">确 定</el-button>
            </div>
        </el-dialog>
        <!-- 场景组内接口 -->
        <el-dialog title="编辑场景组接口" :visible.sync="apiMapVisible" width="500px">
            <el-form :model="apiMapForm">
                <template>
                    <el-form-item required label="接口：" :label-width="formLabelWidth">
                        <el-select class="form-item" v-model="apiMapForm.api" placeholder="请选择API" filterable>
                            <el-option
                                v-for="apiItem in API_LIST"
                                :key="apiItem.api"
                                :label="apiItem.api"
                                :value="apiItem.api"
                            >
                            </el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item required label="场景：" :label-width="formLabelWidth">
                        <el-select class="form-item" v-model="apiMapForm.scene" placeholder="请选择场景" filterable>
                            <template v-for="apiItem in API_LIST" v-if="apiItem.api === apiMapForm.api">
                                <el-option
                                    v-for="scene of apiItem.scenes"
                                    :key="scene"
                                    :label="scene"
                                    :value="scene"
                                >
                                </el-option>
                            </template>
                        </el-select>
                    </el-form-item>
                </template>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="apiMapVisible = false">取 消</el-button>
                <el-button type="primary" @click="saveSceneGroup">确 定</el-button>
            </div>
        </el-dialog>
    </div>
</body>
<script>
    // const search = window.location.search;
    // const defaultUrl = search.indexOf('?url=') === 0 ? search.substr(5) : '';
    new Vue({
        el: '#app',
        data: function() {
            return {
                formLabelWidth: '100px',

                //接口列表
                activeIndex: window.location.hash === '#2' ? '2' : '1',
                isCollapse: false,
                curSearchApi: '',
                activeApi: '',
                API_LIST: [],
                AUTO_API_LIST: [], //第三方平台拉取的，可以自动填充的
                AUTO_API_SCENE: {},// 所有接口自动拉取的第三方场景

                //新增api
                addApiVisible: false,
                apiEditIndex: -1, //编辑还是新增, -1 为新增，其他为编辑
                addApiForm: {
                    api: ''
                },

                //新增api场景
                addApiSceneVisible: false,
                apiSceneEditIndex: -1,
                addApiSceneForm: {
                    scene: '',
                    data: "{}"
                },

                // 场景中心
                curSearchRouter: '',
                activeRouter: '',

                // 新增页面路由
                addRouterVisible: false,
                routerEditIndex: -1, //编辑还是新增, -1 为新增，其他为编辑
                addRouterForm: {
                    url: ''
                },

                //新增路由场景组
                addRouterSceneVisible: false,
                routerSceneEditIndex: -1,
                addRouterSceneForm: {
                    name: ''
                },

                //场景组内接口
                hideSceneGroup: true,
                activeSceneGroup: {}, //当前查看的场景组
                apiMapVisible: false,
                apiMapEditIndex: -1,
                apiMapForm: {
                    id: '',
                    api: '',
                    scene: ''
                },
                ROUTER_SCENE_GROUP_LIST: [],//场景中心数据
            }
        },
        watch: {
            activeApi(newVal){
                if(newVal){
                    const matchAPI = this.API_LIST.find(item => item.api === newVal)
                    matchAPI && matchAPI.id && this.getApiScene(matchAPI.id)
                }
            }
        },
        computed: {
            activeAPISetting(){
                const apiSetting = this.API_LIST.find(item => {
                    return item.api === this.activeApi
                })
                return apiSetting ? apiSetting : {}
            },
            activeScene(){
                if(this.activeAPISetting){
                    const { scenes = [], activeScene:scene = '' } = this.activeAPISetting;
                    if(scenes.includes(scene)){
                        return scene
                    }
                }
                return ''
            },
            activeRouterSetting(){
                const routerSetting = this.ROUTER_SCENE_GROUP_LIST.find(item => {
                    return item.url === this.activeRouter
                })
                return routerSetting ? routerSetting : {}
            }
        },
        created(){
            this.getSceneGroupList(); //获取场景中心数据
            this.getApi(); //获取接口列表数据
        },
        methods: {
            createEditor(data){
                let editor = CodeMirror.fromTextArea(document.getElementById("jsonEditor"), {
                    mode: 'application/json',
                    tabSize: 4,
                    indentUnit : 4,  // 缩进单位，默认2
                    smartIndent : true,  // 是否智能缩进
                    //显示行号
                    styleActiveLine: true,
                    lineNumbers:true,
                    lineWrapping:true,
                    //设置主题
                    //theme:"eclipse",
                    // //绑定Vim
                    //keyMap:"vim",
                    //代码折叠
                    lineWrapping:true,
                    foldGutter: true,
                    gutters:["CodeMirror-linenumbers", "CodeMirror-foldgutter","CodeMirror-lint-markers"],
                    //CodeMirror-lint-markers是实现语法报错功能
                    //lint: true,
                    //括号匹配
                    matchBrackets:true,
                    //快捷键
                    extraKeys:{
                        "Alt-Space": "autocomplete",//ctrl-space唤起智能提示
                        "F11": function(cm) {
                            cm.setOption("fullScreen", !cm.getOption("fullScreen"));
                        },
                        "Esc": function(cm) {
                            if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
                        },
                        "Ctrl-/": "toggleComment",
                        // "Ctrl-S": function () {
                        //     $('#save').click();
                        // },
                        "Ctrl-Z":function (editor) {
                            editor.undo();
                        },//undo
                        "F8":function (editor) {
                            editor.redo();
                        },//Redo
                        "F7": function autoFormat(cm) {
                            var totalLines = cm.lineCount();
                            cm.autoFormatRange({line:0, ch:0}, {line:totalLines});
                        }//代码格式化
                    }
                });
                CodeMirror.commands.autocomplete = function(cm) {
                    cm.showHint({hint: CodeMirror.hint.anyword});
                };
                editor.setValue(data)
                this.editor = editor;
            },
            save(){
                    var ob = this.editor.getValue();  // 得到所有内容
                    try{
                        ob = JSON.parse(JSON.stringify(ob))
                        console.log(ob, 'AAAA____', typeof ob)
                    } catch(e){
                        console.log(1111, e)
                    }
                    console.log(ob, '===obj', typeof ob)
            },
            handleSelect(index){
                this.activeIndex = index;
                this.hideSceneGroup = true;
                window.location.hash = index;
            },
            handleSelectApi(api){
                this.activeApi = api;
            },
            handleSelectRouter(router){
                this.activeRouter = router;
                this.hideSceneGroup = true;
            },
            urlPartten(){
                return new RegExp('(https?|ftp|file)://[-A-Za-z0-9+&@#/%?=~_|!:,.;]+[-A-Za-z0-9+&@#/%=~_|]');
            },
            post(url, data) {
                try {
                    data = JSON.stringify(data)
                    return fetch(url, {
                        body:data,
                        headers: {
                            'content-type': 'application/json'
                        },
                        method: 'POST',
                    })
                    .then(response => response.json()) // parses response to JSON
                } catch {
                    this.$message.error('数据不是合法JSON对象')
                }
            },
            async getSceneGroupList(){
                const res = await this.post('/mockServer/getSceneGroup', {
                    router: this.curUrl
                })
                this.getSceneGroupFinished = true;
                if(res && res.retCode === 200){
                    this.ROUTER_SCENE_GROUP_LIST = res.data || []
                    this.activeRouter = this.ROUTER_SCENE_GROUP_LIST && this.ROUTER_SCENE_GROUP_LIST.length ? this.ROUTER_SCENE_GROUP_LIST[0].url : '';
                    //this.afterGetSceneGroupList(res.data || [])
                }
            },
            // afterGetSceneGroupList(list = []){
            //     this.sceneGroupList = list.map( item => {
            //         const { scenes = [] } = item;
            //         item.scenes = scenes.map(groupItem => {
            //             groupItem.group = groupItem.group || [];
            //             groupItem.group.sort((a, b) => (a.api || '').localeCompare(b.api || ''));
            //             return groupItem;
            //         })
            //         return item;
            //     })
            // },

            async getApi(){
                const res = await this.post('/mockServer/getApi')
                if(res && res.retCode === 200){
                    this.API_LIST = (res.data || []).sort((a, b) => (a.api || '').localeCompare(b.api|| ''));
                    this.activeApi = this.API_LIST && this.API_LIST.length ? this.API_LIST[0].api : '';
                }
            },
            //删除API
            deleteApi(index){
                const params = JSON.parse(JSON.stringify(this.API_LIST));
                this.$confirm('此操作会永久删除该接口及接口下的场景配置，确认删除吗？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    params.splice(index, 1)
                    this.updateApi(params, () => {
                        this.$message.success('删除接口成功')
                        this.activeApi = this.API_LIST && this.API_LIST.length ? this.API_LIST[0].api : '';
                    });
                }).catch((e) => {
                    this.$message({
                        type: 'info',
                        message: '已取消删除'
                    });          
                });
            },
            // 新增API
            async addorEditApi(index, api = ''){
                if(!this.AUTO_API_LIST.length){
                    await this.getApiList();
                }
                this.apiEditIndex = (index || index === 0) ? index : -1;
                this.addApiForm.api = api || ''; 
                this.addApiVisible = true;
            },
            saveApi(){
                let needUpdateActiveAPI = false;
                const { api = '' } = this.addApiForm;
                if(!api){
                    this.$message.error('请输入接口路径～')
                    return false
                }
                const matchAPI = this.AUTO_API_LIST.find(item => item.api === api)

                const params = JSON.parse(JSON.stringify(this.API_LIST));
                if(this.apiEditIndex > -1){
                    if(params[this.apiEditIndex].api === api){
                        this.$message.error('貌似未做任何更改哦~')
                        return false
                    }
                    if(this.activeApi === params[this.apiEditIndex].api){
                        needUpdateActiveAPI = true;
                    }
                    params[this.apiEditIndex].api = api
                    if(matchAPI){
                        params[this.apiEditIndex].id = matchAPI.id;
                    }
                } else {
                    const had = params.find(item => item.api === api)
                    if(had){
                        this.$message.error('接口已存在，请勿重复创建～')
                        return false
                    } else {
                        params.unshift({
                            id: (matchAPI && matchAPI.id) || '',
                            api,
                            activeScene: '',
                            scenes: []
                        })  
                    }
                }
                
                this.updateApi(params, () => {
                    this.$message.success(this.apiEditIndex > -1 ? '编辑接口成功' : '新增接口成功')
                    this.activeApi = api;
                    this.addApiVisible = false;
                });
            },
            async updateApi(params, callback){
                const res = await this.post('/mockServer/updateApi', {
                    apis: params
                })
                if(res && res.retCode === 200){
                    this.API_LIST = params;
                    callback && callback();
                } else {
                    this.$message.error(res && res.retDesc || '数据更新失败')
                }
            },
            //获取所有API及其匹配的场景
            async getApiList(){
                const res = await this.post('/mockServer/getApiList')
                if(res && res.retCode === 200){
                    this.AUTO_API_LIST = (res.data || []).sort((a, b) => (a.api || '').localeCompare(b.api|| ''));
                }
            },

            //删除api场景
            deleteApiScene(index){
                this.$confirm('确认删除该接口下的场景吗？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    const params = JSON.parse(JSON.stringify(this.API_LIST));
                    const apiSetting = params.find(item => item.api === this.activeApi);
                    apiSetting.scenes = apiSetting.scenes || [];

                    let matchSceneGroupName = ''
                    const matchRouter = this.ROUTER_SCENE_GROUP_LIST.find(( {url, scenes = []} ) => {
                        console.log(url , scenes, '=====lx')
                        return scenes.find( ( {group = [], name = ''} ) => {
                            const findScene = group.find(item => item.scene === apiSetting.scenes[index])
                            if(findScene){
                                matchSceneGroupName = name;
                            }
                            return findScene
                        })
                    })
                    if(matchRouter){
                        this.$message.error(`该场景因被路由：${matchRouter.url} 场景组：${matchSceneGroupName} 引用无法被删除，请先解除关联再操作～`)
                        return false
                    }

                    apiSetting.scenes.splice(index, 1)
                    if(!apiSetting.scenes.includes(apiSetting.activeScene)){
                        apiSetting.activeScene = apiSetting.scenes.length ? apiSetting.scenes[0] : '';
                    }
                    this.updateApi(params, () => {
                        this.$message.success('删除接口场景成功')
                        //this.activeApi = this.API_LIST && this.API_LIST.length ? this.API_LIST[0].api : '';
                    });
                }).catch((e) => {
                    this.$message({
                        type: 'info',
                        message: e|| '已取消删除'
                    });          
                });
            },
            //新增api场景
            addApiScene(index, scene = ''){
                // if(!this..length){
                //     await this.getApiList();
                // }
                this.apiSceneEditIndex = (index || index === 0) ? index : -1;
                this.addApiSceneForm.scene = scene || ''; 
                this.addApiSceneForm.data = {};
                this.addApiSceneVisible = true;
                if(scene){
                    this.getMock({
                        api: this.activeApi,
                        scene,
                    })
                }
            },
            async saveApiScene(){
                const { scene = '', data = "{}" } = this.addApiSceneForm;
                if(!scene){
                    this.$message.error('请输入场景名称～')
                    return false
                }
                const params = JSON.parse(JSON.stringify(this.API_LIST));
                const curApiSetting = params.find(item => item.api === this.activeApi);
                if(this.apiSceneEditIndex > -1){
                    curApiSetting.scenes[this.apiSceneEditIndex] = scene;
                } else {
                    if(curApiSetting.scenes.includes(scene)){
                        this.$message.error('场景已存在，请勿重复创建～')
                        return false
                    }
                    curApiSetting.scenes.unshift(scene);
                }

                //需要保存数据
                // this.saveMock({
                //     api: this.activeApi,
                //     scene,
                //     data: JSON.parse(data)
                // })

                this.updateApi(params, () => {
                    this.$message.success(this.apiSceneEditIndex > -1 ? '编辑接口场景成功' : '新增接口场景成功')
                    this.addApiSceneVisible = false;
                })
            },
            // 切换api场景开管
            changeActiveScene(scene, isOn = false){
                const params = JSON.parse(JSON.stringify(this.API_LIST));
                this.$confirm(isOn ? '同一接口同一时间只能有一个场景默认开启，确认开启吗？' : '确认关闭该接口的场景吗？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    const apiSetting = params.find(item => item.api === this.activeApi);
                    apiSetting.activeScene = isOn ? scene : '';
                    this.updateApi(params, () => {
                        this.$message.success(isOn ? '场景切换成功' : '场景关闭成功')
                    });
                }).catch((e) => {
                    this.$message({
                        type: 'info',
                        message: e|| '已取消删除'
                    });          
                });
            },

            //删除路由
            deleteRouter(index){
                const params = JSON.parse(JSON.stringify(this.ROUTER_SCENE_GROUP_LIST));
                this.$confirm('此操作会永久删除该路由及其所有的场景配置，确认删除吗？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    params.splice(index, 1)
                    this.updateRouter(params, () => {
                        this.$message.success('删除页面路由成功')
                        this.activeRouter = this.ROUTER_SCENE_GROUP_LIST && this.ROUTER_SCENE_GROUP_LIST.length ? this.ROUTER_SCENE_GROUP_LIST[0].url : '';
                    });
                }).catch((e) => {
                    this.$message({
                        type: 'info',
                        message: '已取消删除'
                    });          
                });
            },
            //新增路由
            addRouter(index, url = ''){
                this.routerEditIndex = (index || index === 0) ? index : -1;
                this.addRouterForm.url = url || ''; 
                this.addRouterVisible = true;
            },
            async saveRouter(){
                let needUpdateActiveRouter = false;
                const { url = '' } = this.addRouterForm;
                if(!url){
                    this.$message.error('请输入页面路由～')
                    return false
                }
                const params = JSON.parse(JSON.stringify(this.ROUTER_SCENE_GROUP_LIST));
                if(this.routerEditIndex > -1){
                    if(params[this.routerEditIndex].url === url){
                        this.$message.error('貌似未做任何更改哦~')
                        return false
                    }
                    if(this.activeRouter === params[this.routerEditIndex].url){
                        needUpdateActiveRouter = true;
                    }
                    params[this.routerEditIndex].url = url
                } else {
                    const had = params.find(item => item.url === url)
                    if(had){
                        this.$message.error('页面路由已存在，请勿重复创建～')
                        return false
                    } else {
                        params.unshift({
                            url,
                            scenes: []
                        })  
                    }
                }
                
                this.updateRouter(params, () => {
                    this.$message.success(this.routerEditIndex > -1 ? '编辑页面路由成功' : '新增页面路由成功')
                    this.activeRouter = url;
                    this.addRouterVisible = false;
                });
            },
            async updateRouter(params, callback){
                const res = await this.post('/mockServer/updateSceneGroup', { sceneGroupList: params})
                if(res && res.retCode === 200){
                    this.ROUTER_SCENE_GROUP_LIST = params;
                    callback && callback();
                } else {
                    this.$message.error(res && res.retDesc || '数据更新失败')
                }
            },  

            //删除路由场景组
            deleteRouterScene(index){
                const params = JSON.parse(JSON.stringify(this.ROUTER_SCENE_GROUP_LIST));
                this.$confirm('确认删除该场景组吗？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    const setting = params.find(item => item.url === this.activeRouter);
                    setting.scenes = setting.scenes || [];
                    setting.scenes.splice(index, 1)
                    // if(!setting.scenes.includes(setting.activeScene)){
                    //     apiSetting.activeScene = apiSetting.scenes.length ? apiSetting.scenes[0] : '';
                    // }
                    this.updateRouter(params, () => {
                        this.$message.success('删除场景组成功')
                        //this.activeApi = this.API_LIST && this.API_LIST.length ? this.API_LIST[0].api : '';
                    });
                }).catch((e) => {
                    this.$message({
                        type: 'info',
                        message: e|| '已取消删除'
                    });          
                });
            },
            //新增路由场景组
            addRouterScene(index, name = ''){
                this.routerSceneEditIndex = (index || index === 0) ? index : -1;
                this.addRouterSceneForm.name = name || ''; 
                this.addRouterSceneVisible = true;
            },
            async saveRouterScene(){
                const { name = '' } = this.addRouterSceneForm;
                if(!name){
                    this.$message.error('请输入场景组名称～')
                    return false
                }
                const params = JSON.parse(JSON.stringify(this.ROUTER_SCENE_GROUP_LIST));
                const curSetting = params.find(item => item.url === this.activeRouter);
                if(this.routerSceneEditIndex > -1){
                    curSetting.scenes[this.routerSceneEditIndex].name = name;
                } else {
                    if(curSetting.scenes.find(item => item.name === name)){
                        this.$message.error('场景组已存在，请勿重复创建～')
                        return false
                    }
                    curSetting.scenes.unshift({
                        name,
                        group: []
                    });
                }
                
                this.updateRouter(params, () => {
                    this.$message.success(this.routerSceneEditIndex > -1 ? '编辑场景组成功' : '新增场景组成功')
                    this.addRouterSceneVisible = false;
                })
            },
            //切换场景组开关
            changeActiveSceneGroup(scene, isOn = false){
                const params = JSON.parse(JSON.stringify(this.ROUTER_SCENE_GROUP_LIST));
                this.$confirm(isOn ? '同一页面路由同一时间只能有一个场景组默认开启，确认开启吗？' : '确认关闭该场景组吗？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    const setting = params.find(item => item.url === this.activeRouter);
                    setting.activeScene = isOn ? scene : '';
                    this.updateRouter(params, () => {
                        this.$message.success(isOn ? '场景组切换成功' : '场景组关闭成功')
                    });
                }).catch((e) => {
                    this.$message({
                        type: 'info',
                        message: e|| '已取消删除'
                    });          
                });
            },
            //编辑当前场景组详情-既接口列表
            goSceneGroupDetail(index, item){
                this.hideSceneGroup = false;
                this.activeSceneGroup = item;
            },
            goback(){
                this.hideSceneGroup = true;
                this.activeSceneGroup = {};
            },
            //删除场景组的api
            deleteApiMap(index){
                this.$confirm('确定删除场景组下的API吗？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    const { name } = this.activeSceneGroup;
                    const params = JSON.parse(JSON.stringify(this.ROUTER_SCENE_GROUP_LIST))
                    const setting = params.find(item => item.url === this.activeRouter)
                    const sceneGroup = (setting.scenes || []).find(item => item.name === name)
                    sceneGroup.group.splice(index, 1)
                    this.updateRouter(params, () => {
                        this.ROUTER_SCENE_GROUP_LIST = params;
                        this.activeSceneGroup = sceneGroup;
                        this.$message.success('场景组API删除成功')
                    })
                }).catch((e) => {
                    this.$message({
                        type: 'info',
                        message: '已取消删除'
                    });          
                });
            },
            //新增场景组的api
            addApiMap(index, item = {}){
                this.apiMapEditIndex = (index || index === 0) ? index : -1;
                this.apiMapForm.id = item.id || '';
                this.apiMapForm.api = item.api || '';
                this.apiMapForm.scene = item.scene || '';
                this.apiMapVisible = true;
            },
            //保存场景组接口数据
            saveSceneGroup(){
                const { api, scene } = this.apiMapForm;
                const { name } = this.activeSceneGroup;
                if(!api || !scene){
                    this.$message.error('接口和场景缺一不可～')
                    return false;
                }
                const matchAPI = this.API_LIST.find(item => item.api === api)
                if(matchAPI){
                    this.apiMapForm.id = matchAPI.id;
                }
                const params = JSON.parse(JSON.stringify(this.ROUTER_SCENE_GROUP_LIST))
                const setting = params.find(item => item.url === this.activeRouter)
                if(setting){
                    const sceneGroup = (setting.scenes || []).find(item => item.name === name)
                    if(sceneGroup){
                        if(this.apiMapEditIndex > -1){
                            sceneGroup.group[this.apiMapEditIndex] = {
                                id: this.apiMapForm.id || '',
                                api, 
                                scene
                            };
                        } else {
                            if(sceneGroup.group.find(item => item.api === api)){
                                this.$message.error('该场景组下已存在此接口，请勿重复创建～')
                                return false
                            }
                            sceneGroup.group.push({
                                id: this.apiMapForm.id || '',
                                api,
                                scene
                            })
                        }
                
                        this.updateRouter(params, () => {
                            this.apiMapVisible = false;
                            this.activeSceneGroup = sceneGroup;
                            this.ROUTER_SCENE_GROUP_LIST = params;
                            this.$message.success('场景组数据更新成功')
                        })
                        return false
                    }
                }
                this.$message.error('未匹配到场景，请刷新页面重新操作～')
            },


            async getApiScene(id){
                if(this.AUTO_API_SCENE[id]){
                    return false;
                }
                const res = await this.post('/mockServer/getApiScene', {
                    id
                })
                if(res && res.retCode === 200){
                    this.$set(this.AUTO_API_SCENE, id, res.data)
                }
            },
            async getMock({api, scene}){
                const res = await this.post('/mockServer/getData', { 
                    api,
                    scene
                })
                if(res && res.retCode === 200){
                    this.addApiSceneForm.data = JSON.stringify(res.data || {}, null, 4)
                }
            },
            async saveMock({api, scene, data}){
                const res = await this.post('/mockServer/updateData', {
                    scene,
                    api, 
                    data
                })
            }
        }
    })
</script>
</html>